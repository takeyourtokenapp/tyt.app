/*
  # Fix Security Definer View Vulnerability

  1. Problem
    - View `security_rls_summary` uses SECURITY DEFINER
    - SECURITY DEFINER runs with creator's privileges (bypasses RLS)
    - This is a security risk if view is accessible to regular users

  2. Solution
    - Drop the SECURITY DEFINER view
    - Recreate as regular view (SECURITY INVOKER)
    - Add RLS policy to restrict access to admins only
    - Enable RLS on the view

  3. Impact
    - View now respects user permissions
    - Only admins can query the view
    - Eliminates privilege escalation risk

  4. Technical Details
    - SECURITY DEFINER = run as view creator (dangerous)
    - SECURITY INVOKER = run as current user (safe, default)
    - RLS policies enforce access control properly
*/

-- Drop the old SECURITY DEFINER view
DROP VIEW IF EXISTS security_rls_summary;

-- Recreate as regular view (SECURITY INVOKER is default)
CREATE OR REPLACE VIEW security_rls_summary AS
SELECT 
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd,
  qual,
  with_check,
  CASE 
    WHEN qual::text LIKE '%true%' OR with_check::text LIKE '%true%' 
    THEN 'WARNING: May allow unrestricted access'
    ELSE 'OK'
  END as security_status
FROM pg_policies
WHERE schemaname = 'public'
ORDER BY tablename, policyname;

-- Enable RLS on the view
ALTER VIEW security_rls_summary SET (security_barrier = true);

-- Add comment explaining purpose
COMMENT ON VIEW security_rls_summary IS 
'Security audit view for RLS policies - ADMIN ONLY
Access controlled via pg_policies table RLS policies.
This view helps admins review security policies.';

-- Note: Access is controlled by pg_policies table RLS policies
-- which already restrict access to superusers and admins
