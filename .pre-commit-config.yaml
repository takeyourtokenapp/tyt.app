# TYT V3 - Pre-commit Hooks для предотвращения утечки секретов

repos:
  # Detect secrets
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.4.0
    hooks:
      - id: detect-secrets
        args:
          - '--baseline'
          - '.secrets.baseline'
        exclude: |
          (?x)^(
              package-lock.json|
              node_modules/.*|
              \.git/.*|
              dist/.*|
              build/.*
          )$

  # Check for common mistakes
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      # Prevent committing to main/master
      - id: no-commit-to-branch
        args: ['--branch', 'main', '--branch', 'master']

      # Check for files that would conflict in case-insensitive filesystems
      - id: check-case-conflict

      # Check for merge conflicts
      - id: check-merge-conflict

      # Check JSON files
      - id: check-json
        exclude: tsconfig.json

      # Check YAML files
      - id: check-yaml

      # Detect private keys
      - id: detect-private-key

      # Don't allow large files
      - id: check-added-large-files
        args: ['--maxkb=1000']

      # Trim trailing whitespace
      - id: trailing-whitespace

      # Fix end of files
      - id: end-of-file-fixer

      # Check for AWS credentials
      - id: detect-aws-credentials
        args: ['--allow-missing-credentials']

  # Gitleaks - detect secrets
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.18.0
    hooks:
      - id: gitleaks

  # Custom script to check for common patterns
  - repo: local
    hooks:
      - id: check-private-keys
        name: Check for private keys
        entry: bash -c '! git diff --cached --diff-filter=d | grep -i "private.key\|PRIVATE.KEY\|privateKey\|0x[a-fA-F0-9]{64}"'
        language: system
        pass_filenames: false

      - id: check-api-keys
        name: Check for API keys
        entry: bash -c '! git diff --cached --diff-filter=d | grep -E "(api.key|API.KEY|apiKey|secret.key|SECRET.KEY)"'
        language: system
        pass_filenames: false

      - id: check-env-files
        name: Prevent .env files
        entry: bash -c '! git diff --cached --name-only | grep -E "^\.env$|^\.env\."'
        language: system
        pass_filenames: false

      - id: check-wallet-keys
        name: Check for wallet private keys
        entry: bash -c '! git diff --cached --diff-filter=d | grep -iE "(mnemonic|seed.phrase|private.key|wallet.json)"'
        language: system
        pass_filenames: false

      - id: check-supabase-keys
        name: Check for Supabase service keys
        entry: bash -c '! git diff --cached --diff-filter=d | grep -E "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9\.[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+"'
        language: system
        pass_filenames: false

      - id: check-alchemy-keys
        name: Check for Alchemy API keys
        entry: bash -c '! git diff --cached --diff-filter=d | grep -E "[a-zA-Z0-9_-]{32,}"'
        language: system
        pass_filenames: false

      - id: security-check
        name: Run security check script
        entry: bash -c 'if [ -f ./security-check.sh ]; then bash ./security-check.sh; fi'
        language: system
        pass_filenames: false
        always_run: true
