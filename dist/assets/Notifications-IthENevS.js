import{c as E,z as l,E as T,r as m,j as r,u as w,k as M,aj as R,X as q}from"./index-Cb_Vey4A.js";const Y=E("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]]);class x{static async getUserNotifications(i,e){try{let a=l.from("notifications").select("*").eq("user_id",i).order("created_at",{ascending:!1});e?.unreadOnly&&(a=a.eq("read",!1)),e?.type&&(a=a.eq("type",e.type)),e?.limit&&(a=a.limit(e.limit)),a=a.or(`expires_at.is.null,expires_at.gte.${new Date().toISOString()}`);const{data:n,error:d}=await a;return{data:n,error:d}}catch(a){return console.error("Error fetching notifications:",a),{data:null,error:a}}}static async getUnreadCount(i){try{const{data:e,error:a}=await l.from("notifications").select("id",{count:"exact",head:!0}).eq("user_id",i).eq("read",!1).or(`expires_at.is.null,expires_at.gte.${new Date().toISOString()}`);return a?(console.error("Error getting unread count:",a),0):e?.count||0}catch(e){return console.error("Error getting unread count:",e),0}}static async createNotification(i){try{const{data:e,error:a}=await l.from("notifications").insert({...i,read:!1}).select().single();return e&&await this.sendEmailNotification(i.user_id,e),{data:e,error:a}}catch(e){return console.error("Error creating notification:",e),{data:null,error:e}}}static async markAsRead(i){try{const{error:e}=await l.from("notifications").update({read:!0,read_at:new Date().toISOString()}).eq("id",i);return{error:e}}catch(e){return console.error("Error marking notification as read:",e),{error:e}}}static async markAllAsRead(i){try{const{error:e}=await l.from("notifications").update({read:!0,read_at:new Date().toISOString()}).eq("user_id",i).eq("read",!1);return{error:e}}catch(e){return console.error("Error marking all notifications as read:",e),{error:e}}}static async deleteNotification(i){try{const{error:e}=await l.from("notifications").delete().eq("id",i);return{error:e}}catch(e){return console.error("Error deleting notification:",e),{error:e}}}static async deleteAllRead(i){try{const{error:e}=await l.from("notifications").delete().eq("user_id",i).eq("read",!0);return{error:e}}catch(e){return console.error("Error deleting read notifications:",e),{error:e}}}static async getPreferences(i){try{const{data:e,error:a}=await l.from("notification_preferences").select("*").eq("user_id",i).maybeSingle();return e?{data:e,error:a}:{data:{email_enabled:!0,push_enabled:!0,in_app_enabled:!0,types:{system:!0,transaction:!0,mining:!0,maintenance:!0,marketplace:!0,security:!0,kyc:!0,foundation:!0,referral:!0,promotion:!1}},error:null}}catch(e){return console.error("Error fetching notification preferences:",e),{data:null,error:e}}}static async updatePreferences(i,e){try{const{data:a,error:n}=await l.from("notification_preferences").upsert({user_id:i,...e,updated_at:new Date().toISOString()}).select().single();return{data:a,error:n}}catch(a){return console.error("Error updating notification preferences:",a),{data:null,error:a}}}static async sendEmailNotification(i,e){try{const{data:a}=await this.getPreferences(i);if(!a?.email_enabled||!a.types[e.type])return;const{data:n}=await l.from("profiles").select("email").eq("id",i).maybeSingle();if(!n?.email)return;await l.functions.invoke("send-email",{body:{to:n.email,subject:e.title,template:"notification",data:{title:e.title,message:e.message,actionUrl:e.action_url,actionLabel:e.action_label}}})}catch(a){console.error("Error sending email notification:",a)}}static subscribeToNotifications(i,e){const a=l.channel(`notifications:${i}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`user_id=eq.${i}`},n=>{e(n.new)}).subscribe();return()=>{a.unsubscribe()}}static async notifyTransaction(i,e,a,n,d){const f={deposit:"Deposit Received",withdrawal:"Withdrawal Processed",reward:"Mining Reward"},u={deposit:`Your deposit of ${a} ${n} has been confirmed.`,withdrawal:`Your withdrawal of ${a} ${n} has been processed.`,reward:`You earned ${a} ${n} in mining rewards!`};return this.createNotification({user_id:i,type:"transaction",priority:"normal",title:f[e],message:u[e],action_url:d?`/app/wallet?tx=${d}`:"/app/wallet",action_label:"View Transaction",metadata:{amount:a,currency:n,txHash:d}})}static async notifyMaintenance(i,e,a,n=!1){return this.createNotification({user_id:i,type:"maintenance",priority:n?"high":"normal",title:n?"Urgent: Maintenance Payment Due":"Maintenance Payment Due",message:`Your maintenance payment of $${e.toFixed(2)} is due on ${a.toLocaleDateString()}.`,action_url:"/app/wallet",action_label:"Pay Now",metadata:{amount:e,dueDate:a.toISOString()}})}static async notifyKYC(i,e,a,n){const d={approved:"KYC Verification Approved",rejected:"KYC Verification Rejected",review:"KYC Under Review"},f={approved:`Congratulations! Your KYC verification (Tier ${a}) has been approved.`,rejected:`Your KYC verification was rejected. ${n||"Please resubmit your documents."}`,review:"Your KYC documents are under review. We'll notify you once complete."};return this.createNotification({user_id:i,type:"kyc",priority:e==="approved"?"normal":"high",title:d[e],message:f[e],action_url:"/app/settings",action_label:e==="rejected"?"Resubmit":"View Details",metadata:{status:e,tier:a,reason:n}})}static async notifySecurityAlert(i,e,a){return this.createNotification({user_id:i,type:"security",priority:"urgent",title:"Security Alert",message:a,action_url:"/app/settings",action_label:"Review Security",metadata:{alertType:e}})}}function P(){const{user:c}=T(),[i,e]=m.useState([]),[a,n]=m.useState([]),[d,f]=m.useState(!0),[u,p]=m.useState("all"),[h,N]=m.useState("all"),[y,v]=m.useState(""),j=[{value:"all",label:"All Types",icon:"ðŸ“¢"},{value:"transaction",label:"Transactions",icon:"ðŸ’°"},{value:"mining",label:"Mining",icon:"â›ï¸"},{value:"maintenance",label:"Maintenance",icon:"ðŸ”§"},{value:"marketplace",label:"Marketplace",icon:"ðŸª"},{value:"security",label:"Security",icon:"ðŸ”’"},{value:"kyc",label:"KYC",icon:"âœ“"},{value:"foundation",label:"Foundation",icon:"â¤ï¸"},{value:"referral",label:"Referrals",icon:"ðŸŽ"},{value:"promotion",label:"Promotions",icon:"ðŸŽ‰"}];m.useEffect(()=>{if(c){_();const t=x.subscribeToNotifications(c.id,s=>{e(o=>[s,...o])});return()=>t()}},[c]),m.useEffect(()=>{k()},[i,u,h,y]);const _=async()=>{if(!c)return;f(!0);const{data:t}=await x.getUserNotifications(c.id,{limit:100});t&&e(t),f(!1)},k=()=>{let t=[...i];if(u==="unread"?t=t.filter(s=>!s.read):u==="read"&&(t=t.filter(s=>s.read)),h!=="all"&&(t=t.filter(s=>s.type===h)),y){const s=y.toLowerCase();t=t.filter(o=>o.title.toLowerCase().includes(s)||o.message.toLowerCase().includes(s))}n(t)},b=async t=>{await x.markAsRead(t),e(s=>s.map(o=>o.id===t?{...o,read:!0}:o))},S=async()=>{c&&(await x.markAllAsRead(c.id),e(t=>t.map(s=>({...s,read:!0}))))},C=async t=>{await x.deleteNotification(t),e(s=>s.filter(o=>o.id!==t))},$=async()=>{if(!(!c||!window.confirm("Delete all notifications? This cannot be undone."))){for(const t of i)await x.deleteNotification(t.id);e([])}},A=t=>({transaction:"ðŸ’°",mining:"â›ï¸",maintenance:"ðŸ”§",marketplace:"ðŸª",security:"ðŸ”’",kyc:"âœ“",foundation:"â¤ï¸",referral:"ðŸŽ",promotion:"ðŸŽ‰"})[t]||"ðŸ“¢",D=t=>{const s=Math.floor((new Date().getTime()-new Date(t).getTime())/1e3);return s<60?"just now":s<3600?`${Math.floor(s/60)}m ago`:s<86400?`${Math.floor(s/3600)}h ago`:s<604800?`${Math.floor(s/86400)}d ago`:new Date(t).toLocaleDateString()},g=i.filter(t=>!t.read).length;return d?r.jsx("div",{className:"flex items-center justify-center h-64",children:r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsx("div",{className:"w-6 h-6 border-3 border-amber-400 border-t-transparent rounded-full animate-spin"}),r.jsx("div",{className:"text-gray-400 text-lg",children:"Loading notifications..."})]})}):r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center justify-between gap-4",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"text-3xl font-bold mb-2 bg-gradient-to-r from-amber-400 to-amber-600 bg-clip-text text-transparent",children:"Notifications"}),r.jsx("p",{className:"text-gray-400",children:g>0?`${g} unread notification${g>1?"s":""}`:"All caught up!"})]}),r.jsxs("div",{className:"flex items-center gap-3",children:[g>0&&r.jsxs("button",{onClick:S,className:"px-4 py-2 bg-blue-500/20 text-blue-400 rounded-lg hover:bg-blue-500/30 transition-all flex items-center gap-2",children:[r.jsx(w,{className:"w-4 h-4"}),"Mark All Read"]}),i.length>0&&r.jsxs("button",{onClick:$,className:"px-4 py-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 transition-all flex items-center gap-2",children:[r.jsx(Y,{className:"w-4 h-4"}),"Delete All"]})]})]}),r.jsx("div",{className:"bg-gray-800 rounded-xl p-6 border border-gray-700",children:r.jsxs("div",{className:"grid md:grid-cols-3 gap-4",children:[r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Status"}),r.jsxs("div",{className:"flex gap-2",children:[r.jsxs("button",{onClick:()=>p("all"),className:`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${u==="all"?"bg-amber-500 text-white":"bg-gray-700 text-gray-300 hover:bg-gray-600"}`,children:["All (",i.length,")"]}),r.jsxs("button",{onClick:()=>p("unread"),className:`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${u==="unread"?"bg-blue-500 text-white":"bg-gray-700 text-gray-300 hover:bg-gray-600"}`,children:["Unread (",g,")"]}),r.jsxs("button",{onClick:()=>p("read"),className:`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${u==="read"?"bg-gray-500 text-white":"bg-gray-700 text-gray-300 hover:bg-gray-600"}`,children:["Read (",i.length-g,")"]})]})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Type"}),r.jsx("select",{value:h,onChange:t=>N(t.target.value),className:"w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:border-amber-500 focus:outline-none",children:j.map(t=>r.jsxs("option",{value:t.value,children:[t.icon," ",t.label]},t.value))})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Search"}),r.jsxs("div",{className:"relative",children:[r.jsx(M,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),r.jsx("input",{type:"text",placeholder:"Search notifications...",value:y,onChange:t=>v(t.target.value),className:"w-full pl-10 pr-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:border-amber-500 focus:outline-none"})]})]})]})}),r.jsx("div",{className:"space-y-3",children:a.length===0?r.jsxs("div",{className:"bg-gray-800 rounded-xl p-12 border border-gray-700 text-center",children:[r.jsx(R,{className:"w-16 h-16 text-gray-600 mx-auto mb-4"}),r.jsx("h3",{className:"text-xl font-bold text-gray-400 mb-2",children:"No notifications found"}),r.jsx("p",{className:"text-gray-500",children:y||h!=="all"||u!=="all"?"Try adjusting your filters":"You're all caught up!"})]}):a.map(t=>r.jsx("div",{className:`bg-gray-800 rounded-xl p-6 border transition-all hover:border-amber-500/50 ${t.read?"border-gray-700":"border-blue-500/30 bg-blue-500/5"}`,children:r.jsxs("div",{className:"flex items-start gap-4",children:[r.jsx("div",{className:"text-3xl flex-shrink-0",children:A(t.type)}),r.jsxs("div",{className:"flex-1 min-w-0",children:[r.jsxs("div",{className:"flex items-start justify-between gap-4 mb-2",children:[r.jsxs("div",{className:"flex-1",children:[r.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[r.jsx("h3",{className:"font-bold text-lg text-white",children:t.title}),!t.read&&r.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full"})]}),r.jsx("p",{className:"text-gray-300",children:t.message})]}),r.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[!t.read&&r.jsx("button",{onClick:()=>b(t.id),className:"p-2 hover:bg-gray-700 rounded-lg transition-colors",title:"Mark as read",children:r.jsx(w,{className:"w-5 h-5 text-green-400"})}),r.jsx("button",{onClick:()=>C(t.id),className:"p-2 hover:bg-gray-700 rounded-lg transition-colors",title:"Delete",children:r.jsx(q,{className:"w-5 h-5 text-red-400"})})]})]}),r.jsxs("div",{className:"flex items-center justify-between text-sm",children:[r.jsx("span",{className:"text-gray-500",children:D(t.created_at)}),t.action_url&&r.jsxs("a",{href:t.action_url,className:"text-amber-400 hover:text-amber-300 font-medium flex items-center gap-1",onClick:()=>b(t.id),children:[t.action_label||"View Details"," â†’"]})]})]})]})},t.id))})]})}export{P as default};
